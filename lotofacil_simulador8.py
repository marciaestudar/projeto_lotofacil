# -*- coding: utf-8 -*-
"""lotofacil_simulador8.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZtSpTFM8W_84wc3MAXeDI22FjclREpsH
"""

import streamlit as st
import random
import pandas as pd
import collections
from datetime import datetime
import os # Para verificar a exist√™ncia de arquivos

# --- CONFIGURA√á√ïES DA P√ÅGINA ---
st.set_page_config(
    page_title="Simulador e Estat√≠sticas Lotof√°cil",
    page_icon="üé≤",
    layout="wide" # Layout mais amplo para acomodar mais conte√∫do
)

st.title("üé≤ Simulador e Estat√≠sticas da Lotof√°cil")
st.write("Gere sorteios, confira seus acertos e compare com os dados oficiais da Caixa.")

# --- Nomes dos arquivos de dados CSV ---
ARQUIVO_HISTORICO_OFICIAL_CSV = 'Lotofacil.csv'
ARQUIVO_TABELA_PRECO_CSV = 'Tabela_Preco.csv'

# --- Inicializa√ß√£o do Estado da Sess√£o ---
# Hist√≥rico de Sorteios Simulados
if 'historico_sorteios_simulados' not in st.session_state:
    st.session_state.historico_sorteios_simulados = []

# Vari√°vel para armazenar o √∫ltimo sorteio gerado (simulado) antes de ir para o hist√≥rico
if 'ultimo_sorteio_gerado_simulado' not in st.session_state:
    st.session_state.ultimo_sorteio_gerado_simulado = None

# --- Fun√ß√µes para Carregar/Salvar Dados CSV ---

@st.cache_data(ttl=3600) # Cache por 1 hora para dados oficiais
def carregar_dados_oficiais():
    """Carrega o hist√≥rico de sorteios oficiais da Lotof√°cil de um CSV."""
    if os.path.exists(ARQUIVO_HISTORICO_OFICIAL_CSV):
        try:
            df = pd.read_csv(ARQUIVO_HISTORICO_OFICIAL_CSV, sep=',')

            # --- DIAGN√ìSTICO: Imprime as colunas lidas do CSV no terminal ---
            print(f"Colunas lidas de {ARQUIVO_HISTORICO_OFICIAL_CSV}: {df.columns.tolist()}")
            # ------------------------------------------------------------------

            # Tenta converter a coluna 'Data Sorteio' para datetime, tratando erros
            df['Data Sorteio'] = pd.to_datetime(df['Data Sorteio'], errors='coerce', dayfirst=True)
            df.dropna(subset=['Data Sorteio'], inplace=True) # Remove linhas com data inv√°lida (NaT)

            return df
        except Exception as e:
            st.error(f"Erro ao carregar o arquivo '{ARQUIVO_HISTORICO_OFICIAL_CSV}'. Verifique se ele est√° no formato CSV e as colunas est√£o corretas: {e}")
            return pd.DataFrame() # Retorna DataFrame vazio em caso de erro
    return pd.DataFrame()

def salvar_novo_sorteio_oficial(novo_sorteio_df):
    """Salva um novo sorteio oficial no arquivo CSV."""
    df_existente = carregar_dados_oficiais()

    # Remover do cache antes de modificar o arquivo
    st.cache_data.clear() # Limpa todos os caches de dados

    # Adiciona o novo sorteio. Usa ignore_index=True para garantir um novo √≠ndice limpo.
    df_atualizado = pd.concat([df_existente, novo_sorteio_df], ignore_index=True)
    df_atualizado.to_csv(ARQUIVO_HISTORICO_OFICIAL_CSV, index=False, sep=',')
    st.success(f"Novo concurso {novo_sorteio_df['Concurso'].iloc[0]} adicionado com sucesso!")
    st.rerun() # Recarrega a p√°gina para refletir as mudan√ßas

@st.cache_data(ttl=3600) # Cache por 1 hora para tabela de pre√ßos
def carregar_tabela_precos():
    """Carrega a tabela de pre√ßos do jogo de um CSV."""
    if os.path.exists(ARQUIVO_TABELA_PRECO_CSV):
        try:
            df = pd.read_csv(ARQUIVO_TABELA_PRECO_CSV, sep=',')
            return df
        except Exception as e:
            st.error(f"Erro ao carregar o arquivo '{ARQUIVO_TABELA_PRECO_CSV}'. Verifique se ele est√° no formato CSV e as colunas est√£o corretas: {e}")
            return pd.DataFrame()
    return pd.DataFrame()


# --- Fun√ß√µes do Simulador e Estat√≠sticas ---

def gerar_sorteio_lotofacil():
    """Gera 15 n√∫meros √∫nicos entre 1 e 25."""
    sorteio = random.sample(range(1, 26), 15)
    sorteio.sort()
    return sorteio

def adicionar_sorteio_simulado_ao_historico(sorteio_para_adicionar):
    """
    Adiciona um sorteio ao hist√≥rico de sorteios simulados,
    mas apenas se j√° houver um sorteio 'anterior' no ultimo_sorteio_gerado_simulado.
    """
    if st.session_state.ultimo_sorteio_gerado_simulado is not None:
        data_anterior = datetime.now().strftime("%d/%m/%Y %H:%M:%S")
        st.session_state.historico_sorteios_simulados.append({
            'data': data_anterior,
            'sorteio': st.session_state.ultimo_sorteio_gerado_simulado
        })
    st.session_state.ultimo_sorteio_gerado_simulado = sorteio_para_adicionar

def calcular_estatisticas_oficiais(df_sorteios):
    """Calcula a frequ√™ncia de cada n√∫mero em um DataFrame de sorteios oficiais."""
    if df_sorteios.empty:
        return pd.DataFrame({'N√∫mero': [], 'Frequ√™ncia': []})

    # Coleta todas as bolas de Bola1 a Bola15
    colunas_bolas = [f'Bola{i}' for i in range(1, 16)]
    # Filtra para ter certeza que as colunas existem antes de tentar coletar
    colunas_existentes = [col for col in colunas_bolas if col in df_sorteios.columns]

    if not colunas_existentes:
        st.warning("N√£o foram encontradas as colunas de bolas (Bola1-Bola15) necess√°rias para calcular as estat√≠sticas oficiais. Verifique a estrutura do seu CSV.")
        return pd.DataFrame({'N√∫mero': [], 'Frequ√™ncia': []})

    todos_numeros_sorteados = df_sorteios[colunas_existentes].values.flatten().tolist()

    frequencia = collections.Counter(todos_numeros_sorteados)
    df_frequencia = pd.DataFrame(frequencia.items(), columns=['N√∫mero', 'Frequ√™ncia'])
    df_frequencia = df_frequencia.sort_values(by='Frequ√™ncia', ascending=False)
    return df_frequencia

# --- LAYOUT DA APLICA√á√ÉO STREAMLIT ---

# Cria√ß√£o de abas (tabs) para organizar o conte√∫do
tab1, tab2, tab3, tab4 = st.tabs(["Simulador e Confer√™ncia", "Estat√≠sticas Oficiais", "Inserir Concurso Oficial", "Tabela de Pre√ßos"])

# --- ABA 1: Simulador e Confer√™ncia ---
with tab1:
    st.header("Gerar Novo Sorteio Simulado")
    if st.button("Sortear N√∫meros"):
        novo_sorteio_simulado = gerar_sorteio_lotofacil()
        adicionar_sorteio_simulado_ao_historico(novo_sorteio_simulado)
        st.success(f"Seu sorteio atual: **{', '.join(map(str, novo_sorteio_simulado))}**")

    # Hist√≥rico de Sorteios Simulados (mantido para o slider, mas sem estat√≠sticas)
    if st.session_state.historico_sorteios_simulados:
        st.subheader("Hist√≥rico de Seus Sorteios Simulados")

        total_sorteios_simulados = len(st.session_state.historico_sorteios_simulados)

        if total_sorteios_simulados > 1:
            initial_slider_value_simulado = min(10, total_sorteios_simulados)
            num_sorteios_para_mostrar_simulados = st.slider(
                "Mostrar √∫ltimos X sorteios simulados:",
                min_value=1,
                max_value=total_sorteios_simulados,
                value=initial_slider_value_simulado,
                key="slider_simulados" # Chave √∫nica para o slider
            )
        else:
            num_sorteios_para_mostrar_simulados = 1

        st.write(f"√öltimos {num_sorteios_para_mostrar_simulados} sorteios registrados:")
        for i, registro in enumerate(reversed(st.session_state.historico_sorteios_simulados[-num_sorteios_para_mostrar_simulados:])):
            st.markdown(f"**Sorteio {total_sorteios_simulados - i} em {registro['data']}:** {', '.join(map(str, registro['sorteio']))}")

        if st.button("Limpar Hist√≥rico de Simulados"):
            st.session_state.historico_sorteios_simulados = []
            st.session_state.ultimo_sorteio_gerado_simulado = None
            st.success("Hist√≥rico de sorteios simulados limpo!")
            st.rerun()
    else:
        st.info("O hist√≥rico de sorteios simulados come√ßar√° a ser registrado a partir do segundo sorteio. Gere seu primeiro sorteio!")

    # --- NOVA FUNCIONALIDADE: Confer√™ncia de Jogo ---
    st.header("Conferir seu Jogo Simulado com N√∫meros Oficiais")
    if st.session_state.ultimo_sorteio_gerado_simulado:
        st.markdown(f"**Seu √∫ltimo jogo simulado:** {', '.join(map(str, st.session_state.ultimo_sorteio_gerado_simulado))}")

        with st.form("form_conferencia_jogo"):
            st.write("Insira os 15 n√∫meros oficiais sorteados pela Caixa (separados por v√≠rgula ou espa√ßo):")
            numeros_oficiais_str = st.text_input(
                "N√∫meros Oficiais (ex: 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 24, 25)",
                key="numeros_oficiais_input"
            )
            conferir_button = st.form_submit_button("Conferir Acertos")

            if conferir_button:
                try:
                    # Limpa e converte os n√∫meros oficiais para inteiros e depois para set
                    oficiais_lista = [int(n.strip()) for n in numeros_oficiais_str.replace(',', ' ').split() if n.strip().isdigit()]

                    if len(set(oficiais_lista)) != 15:
                        st.error("Por favor, insira exatamente 15 n√∫meros √∫nicos para os n√∫meros oficiais.")
                    elif not all(1 <= num <= 25 for num in oficiais_lista):
                        st.error("Os n√∫meros oficiais devem estar entre 1 e 25.")
                    else:
                        jogo_simulado_set = set(st.session_state.ultimo_sorteio_gerado_simulado)
                        oficiais_set = set(oficiais_lista)

                        acertos = jogo_simulado_set.intersection(oficiais_set)

                        st.success(f"Voc√™ acertou **{len(acertos)}** n√∫meros!")
                        if len(acertos) > 0:
                            st.write(f"N√∫meros acertados: {', '.join(map(str, sorted(list(acertos))))}")
                except ValueError:
                    st.error("Por favor, insira os n√∫meros oficiais em um formato v√°lido (apenas n√∫meros separados por v√≠rgulas ou espa√ßos).")
    else:
        st.info("Gere um sorteio simulado para poder conferir seus acertos.")


# --- ABA 2: Estat√≠sticas Oficiais ---
with tab2:
    st.header("Estat√≠stica: N√∫meros Oficiais da Caixa")
    df_oficial = carregar_dados_oficiais() # Carrega os dados oficiais (usando cache)

    if not df_oficial.empty:
        st.subheader("Hist√≥rico Completo de Sorteios Oficiais")

        # --- AJUSTE: Filtra as colunas para exibi√ß√£o, pegando apenas as que existem ---
        expected_cols = ['Concurso', 'Data Sorteio'] + [f'Bola{i}' for i in range(1, 16)]
        existing_cols_to_display = [col for col in expected_cols if col in df_oficial.columns]

        # Formata 'Data Sorteio' para exibi√ß√£o (DD/MM/AAAA)
        df_display = df_oficial.copy() # Cria uma c√≥pia para n√£o alterar o DataFrame original
        if 'Data Sorteio' in df_display.columns:
            # Garante que √© datetime antes de formatar, e lida com NaT
            df_display['Data Sorteio'] = df_display['Data Sorteio'].dt.strftime('%d/%m/%Y').fillna('Data Inv√°lida')

        if existing_cols_to_display:
            st.dataframe(df_display[existing_cols_to_display], use_container_width=True)
        else:
            st.warning("Nenhuma das colunas esperadas ('Concurso', 'Data Sorteio', 'Bola1'...'Bola15') foi encontrada no arquivo CSV oficial para exibi√ß√£o. Verifique os cabe√ßalhos do seu arquivo.")
        # -----------------------------------------------------------------------------

        st.subheader("Frequ√™ncia dos N√∫meros Oficiais")
        df_estatisticas_oficiais = calcular_estatisticas_oficiais(df_oficial)

        if not df_estatisticas_oficiais.empty:
            st.write("Frequ√™ncia de cada n√∫mero nos sorteios oficiais:")
            st.dataframe(df_estatisticas_oficiais, use_container_width=True)
            st.subheader("Gr√°fico de Frequ√™ncia de Oficiais")
            st.bar_chart(df_estatisticas_oficiais.set_index('N√∫mero'))
            st.info(f"Total de concursos oficiais carregados: {len(df_oficial)}")
        else:
            st.warning("N√£o foi poss√≠vel calcular as estat√≠sticas dos n√∫meros oficiais. Verifique a estrutura das colunas 'Bola1'...'Bola15' no seu CSV.")
    else:
        st.warning(f"Arquivo '{ARQUIVO_HISTORICO_OFICIAL_CSV}' n√£o encontrado ou vazio. Por favor, adicione um arquivo CSV com o hist√≥rico de sorteios oficiais ou insira novos concursos na aba 'Inserir Concurso Oficial'.")

# --- ABA 3: Inserir Concurso Oficial ---
with tab3:
    st.header("Adicionar Novo Concurso Oficial da Caixa")
    st.write("Preencha os campos abaixo para adicionar um novo resultado de concurso oficial.")

    with st.form("form_novo_concurso"):
        col1, col2 = st.columns(2)
        with col1:
            concurso = st.number_input("N√∫mero do Concurso", min_value=1, step=1, key="concurso_input")
        with col2:
            data_sorteio = st.date_input("Data do Sorteio", datetime.now().date(), key="data_sorteio_input") # .date() para pegar apenas a data

        st.subheader("Bolas Sorteadas (1 a 25)")

        # Cria 3 linhas de 5 colunas para as bolas
        bolas = []
        for row in range(3):
            cols_bolas = st.columns(5)
            for i in range(5):
                bola_index = row * 5 + i + 1
                bola_val = cols_bolas[i].number_input(
                    f"Bola {bola_index}",
                    min_value=1,
                    max_value=25,
                    step=1,
                    key=f"bola_{bola_index}_input"
                )
                bolas.append(bola_val)

        submitted = st.form_submit_button("Adicionar Concurso")

        if submitted:
            # Validar se os 15 n√∫meros s√£o √∫nicos e v√°lidos
            if len(set(bolas)) != 15:
                st.error("Por favor, insira 15 n√∫meros √∫nicos para as bolas sorteadas.")
            elif any(not (1 <= b <= 25) for b in bolas):
                st.error("As bolas devem ser n√∫meros entre 1 e 25.")
            else:
                # Criar um DataFrame para o novo sorteio
                novo_sorteio_dict = {
                    'Concurso': int(concurso),
                    'Data Sorteio': data_sorteio.strftime("%Y-%m-%d") # Formato AAAA-MM-DD para consist√™ncia no CSV
                }
                # Garante que as bolas est√£o em ordem crescente para o CSV
                bolas_ordenadas = sorted(bolas)
                for i, bola in enumerate(bolas_ordenadas):
                    novo_sorteio_dict[f'Bola{i+1}'] = bola

                novo_df = pd.DataFrame([novo_sorteio_dict])

                try:
                    salvar_novo_sorteio_oficial(novo_df)
                    # A mensagem de sucesso e rerunning j√° est√£o dentro de salvar_novo_sorteio_oficial
                except Exception as e:
                    st.error(f"Erro ao salvar o concurso: {e}")

# --- ABA 4: Tabela de Pre√ßos ---
with tab4:
    st.header("Tabela de Pre√ßos da Lotof√°cil")
    df_precos = carregar_tabela_precos()

    if not df_precos.empty:
        st.dataframe(df_precos, use_container_width=True)
    else:
        st.warning(f"Arquivo '{ARQUIVO_TABELA_PRECO_CSV}' n√£o encontrado ou vazio. Por favor, adicione um arquivo CSV com a tabela de pre√ßos.")

st.markdown("---")
st.markdown("Desenvolvido com ‚ù§Ô∏è por [Seu Nome/Empresa]")